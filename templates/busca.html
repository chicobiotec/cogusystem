{% extends "base.html" %}

{% block title %}Busca - Sistema para Bioprospecção de Cogumelos{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-search"></i> Sistema de Busca</h2>
        <p class="text-muted">Busque por coletas, isolados e experimentos em todo o sistema</p>
    </div>
</div>

<!-- Formulário de Busca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-search"></i> Busca Avançada</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('busca') }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="q" class="form-label">
                                <i class="bi bi-search"></i> Termo de Busca
                            </label>
                            <input type="text" class="form-control" id="q" name="q" 
                                   value="{{ query }}" placeholder="Digite o que deseja buscar..."
                                   required>
                            <div class="form-text">
                                Busque por códigos, nomes, locais, meios de cultura, títulos, etc.
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="tipo" class="form-label">
                                <i class="bi bi-filter"></i> Tipo de Busca
                            </label>
                            <select class="form-select" id="tipo" name="tipo">
                                <option value="todos" {% if tipo == 'todos' %}selected{% endif %}>Todos os Tipos</option>
                                <option value="coletas" {% if tipo == 'coletas' %}selected{% endif %}>Apenas Coletas</option>
                                <option value="isolados" {% if tipo == 'isolados' %}selected{% endif %}>Apenas Isolados</option>
                                <option value="experimentos" {% if tipo == 'experimentos' %}selected{% endif %}>Apenas Experimentos</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resultados da Busca -->
{% if query %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> Resultados da Busca para "{{ query }}"
                </h5>
            </div>
            <div class="card-body">
                {% if resultados %}
                    <!-- Coletas -->
                    {% if resultados.coletas %}
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-collection"></i> Coletas Encontradas ({{ resultados.coletas|length }})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nome Científico</th>
                                        <th>Local</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for coleta in resultados.coletas %}
                                    <tr>
                                        <td><strong>{{ coleta.codigo }}</strong></td>
                                        <td>
                                            {% if coleta.nome_cientifico %}
                                                <em>{{ coleta.nome_cientifico }}</em>
                                            {% else %}
                                                <span class="text-muted">Não informado</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ coleta.local_coleta }}</td>
                                        <td>{{ coleta.data_coleta.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <a href="{{ url_for('coleta_detalhe', id=coleta.id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Isolados -->
                    {% if resultados.isolados %}
                    <div class="mb-4">
                        <h6 class="text-success">
                            <i class="bi bi-petri-dish"></i> Isolados Encontrados ({{ resultados.isolados|length }})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Coleta</th>
                                        <th>Meio Cultura</th>
                                        <th>Data Isolamento</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for isolado in resultados.isolados %}
                                    <tr>
                                        <td><strong>{{ isolado.codigo }}</strong></td>
                                        <td>
                                            {% if isolado.coleta %}
                                                <a href="{{ url_for('coleta_detalhe', id=isolado.coleta.id) }}" 
                                                   class="text-decoration-none">
                                                    {{ isolado.coleta.codigo }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ isolado.meio_cultura }}</td>
                                        <td>{{ isolado.data_isolamento.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <a href="{{ url_for('isolado_detalhe', id=isolado.id) }}" 
                                               class="btn btn-sm btn-outline-success">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Experimentos -->
                    {% if resultados.experimentos %}
                    <div class="mb-4">
                        <h6 class="text-warning">
                            <i class="bi bi-flask"></i> Experimentos Encontrados ({{ resultados.experimentos|length }})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Status</th>
                                        <th>Coleta</th>
                                        <th>Isolado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for experimento in resultados.experimentos %}
                                    <tr>
                                        <td><strong>{{ experimento.titulo }}</strong></td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if experimento.status == 'Concluído' else 'warning' if experimento.status == 'Em andamento' else 'secondary' }}">
                                                {{ experimento.status }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if experimento.coleta %}
                                                <a href="{{ url_for('coleta_detalhe', id=experimento.coleta.id) }}" 
                                                   class="text-decoration-none">
                                                    {{ experimento.coleta.codigo }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if experimento.isolado %}
                                                <a href="{{ url_for('isolado_detalhe', id=experimento.isolado.id) }}" 
                                                   class="text-decoration-none">
                                                    {{ experimento.isolado.codigo }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('experimento_detalhe', id=experimento.id) }}" 
                                               class="btn btn-sm btn-outline-warning">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Resumo dos Resultados -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Resumo da Busca</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h5 class="text-primary">{{ resultados.coletas|length if resultados.coletas else 0 }}</h5>
                                            <small class="text-muted">Coletas</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-success">{{ resultados.isolados|length if resultados.isolados else 0 }}</h5>
                                            <small class="text-muted">Isolados</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-warning">{{ resultados.experimentos|length if resultados.experimentos else 0 }}</h5>
                                            <small class="text-muted">Experimentos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search display-4 text-muted"></i>
                        <h4 class="text-muted mt-3">Nenhum resultado encontrado</h4>
                        <p class="text-muted">
                            Não foram encontrados resultados para "{{ query }}". 
                            Tente usar termos diferentes ou mais específicos.
                        </p>
                        <div class="mt-3">
                            <h6 class="text-muted">Sugestões de busca:</h6>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-arrow-right"></i> Use códigos específicos (ex: COL001, ISO001)</li>
                                <li><i class="bi bi-arrow-right"></i> Busque por nomes científicos ou populares</li>
                                <li><i class="bi bi-arrow-right"></i> Use nomes de locais ou substratos</li>
                                <li><i class="bi bi-arrow-right"></i> Busque por títulos de experimentos</li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Dicas de Busca -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Dicas de Busca</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="bi bi-collection text-primary"></i> Buscar Coletas</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-right"></i> Códigos de coleta</li>
                            <li><i class="bi bi-arrow-right"></i> Nomes científicos</li>
                            <li><i class="bi bi-arrow-right"></i> Locais de coleta</li>
                            <li><i class="bi bi-arrow-right"></i> Nomes de coletores</li>
                        </ul>
                    </div>
                    
                    <div class="col-md-4">
                        <h6><i class="bi bi-petri-dish text-success"></i> Buscar Isolados</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-right"></i> Códigos de isolado</li>
                            <li><i class="bi bi-arrow-right"></i> Meios de cultura</li>
                            <li><i class="bi bi-arrow-right"></i> Datas de isolamento</li>
                            <li><i class="bi bi-arrow-right"></i> Códigos de coleta</li>
                        </ul>
                    </div>
                    
                    <div class="col-md-4">
                        <h6><i class="bi bi-flask text-warning"></i> Buscar Experimentos</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-right"></i> Títulos de experimentos</li>
                            <li><i class="bi bi-arrow-right"></i> Objetivos</li>
                            <li><i class="bi bi-arrow-right"></i> Status</li>
                            <li><i class="bi bi-arrow-right"></i> Palavras-chave</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exemplos de Busca -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-search"></i> Exemplos de Busca</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Busca por Códigos:</h6>
                        <ul>
                            <li><code>COL</code> - Todas as coletas</li>
                            <li><code>ISO</code> - Todos os isolados</li>
                            <li><code>2024</code> - Itens de 2024</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Busca por Conteúdo:</h6>
                        <ul>
                            <li><code>PDA</code> - Meios de cultura</li>
                            <li><code>pigmento</code> - Experimentos sobre pigmentos</li>
                            <li><code>Serra</code> - Locais de coleta</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Foco automático no campo de busca
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('q').focus();
    });
    
    // Busca em tempo real (opcional)
    document.getElementById('q').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 3) {
            // Aqui você pode implementar busca em tempo real se desejar
            console.log('Busca em tempo real para:', query);
        }
    });
</script>
{% endblock %}
